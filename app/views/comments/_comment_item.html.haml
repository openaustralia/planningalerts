%figure.comment-item.panel{class: ("comment-to-councillor" if comment.councillor), id: "comment#{comment.id}"}
  - if with_address
    %h2.comment-location
      In
      %strong #{comment.application.suburb} #{comment.application.state}
      on
      = link_to application_path(comment.application.id), title: "View application", class: "comment-application" do
        #{display_description_with_address(comment.application)}:
  .panel-body
    %figcaption.comment-meta.comment-heading
      %span.comment-author= comment.name
      - if comment.councillor
        wrote to
        %span.comment-recipient.h-card
          local councillor
          %span.p-name= comment.councillor.name
      %span.comment-time-block
        = "commented" unless comment.councillor
        = link_to comment_path(comment), title: "View comment" do
          %time.comment-time{datetime: comment.updated_at.strftime("%F")}
            #{time_ago_in_words(comment.updated_at)} ago
    %blockquote.comment-text= comment_as_html(comment.text)
    %footer
      - unless comment.councillor
        %p.comment-meta delivered to the planning authority
      .comment-actions
        - if current_user && current_user.admin?
          - if comment.councillor
            = link_to "add reply", new_admin_reply_path("reply[comment_id]" => comment), class: 'comment-action'
          = link_to "admin", admin_application_comment_path(comment), class: 'comment-action'
        - unless current_page?(new_comment_report_path(comment.id))
          = link_to "report comment", new_comment_report_path(comment), title: "Report this comment by #{comment.name} for removal", class: "comment-action"
  - if comment.councillor && comment.replies.empty?
    .panel-body.comment-to-councillor-status
      %p
        Delivered to #{comment.councillor.prefixed_name} #{time_ago_in_words(comment.updated_at)} ago.
        %span They are yet to respond.
- comment.replies.each do |reply|
  %figure.reply-from-councillor.comment-item.panel{id: "reply#{reply.id}"}
    .panel-body
      .comment-heading.h-card
        - if reply.councillor.image_url.present?
          .councillor-image-wrapper
            .councillor-image
              = image_tag reply.councillor.image_url,
                          alt: "Photo of #{reply.councillor.name}",
                          class: "u-photo"
        %figcaption.comment-meta
          .comment-author.councillor
            %span.p-name= reply.councillor.name
            %span.p-role local councillor for #{reply.councillor.authority.full_name}
          %span.comment-time-block
            replied to
            = link_to reply.comment.name, "#comment#{reply.comment.id}", title: "View comment"
            = link_to "#reply#{reply.id}", title: "View reply" do
              %time.comment-time{datetime: reply.received_at.strftime("%F")}
                #{time_ago_in_words(reply.received_at)} ago
      %blockquote.comment-text= reply.text
      - if current_user && current_user.admin?
        %footer
          .comment-actions
            = link_to "admin", admin_reply_path(reply),class: 'comment-action'
