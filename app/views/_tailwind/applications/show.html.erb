<% content_for :page_title, page_title(@application) %>
<% content_for :meta_description, @application.description %>
<% content_for :extra_meta_tags do %>
  <%# TODO: Remove twitter stuff here %>
  <meta content="summary" name="twitter:card">
  <meta content="@PlanningAlerts" name="twitter:site">
  <meta content="<%= @application.address %>" name="twitter:title">
  <meta content="<%= (@application.description[0..199] if @application.description) %>" name="twitter:description">
  <meta content="<%= google_static_map_url(lat: @application.lat, lng: @application.lng, size: "512x512") %>" name="twitter:image">
  <meta content="<%= application_url(@application) %>" property="og:url">
  <meta content="place" property="og:type">
  <meta content="<%= @application.address %>" property="og:title">
  <meta content="<%= (@application.description[0..199] if @application.description) %>" property="og:description">
  <meta content="<%= google_static_map_url(lat: @application.lat, lng: @application.lng, size: "512x512") %>" property="og:image">
  <meta content="512" property="og:image:width">
  <meta content="512" property="og:image:height">
  <% if @application.location %>
    <meta content="<%= @application.lat %>" property="place:location:latitude">
    <meta content="<%= @application.lng %>" property="place:location:longitude">
  <% end %>
<% end %>
<% content_for :footer_illustration do %>
  <%= image_tag "tailwind/illustration/bottom-of-page-man.svg", alt: "" %>
<% end %>

<%# TODO: Using non-standard style %>
<%= render Tailwind::Heading.new(tag: :h1, font: "sans", extra_classes: "mb-10").with_content(@application.address) %>

<%# TODO: Weird that the line below fails a test if it's just "map" rather than "applications/map" %>
<%= render "applications/map", application: @application %>

<dl class="mt-16 grid md:grid-cols-[18rem_1fr] text-navy text-2xl">
  <dt class="font-bold">Description</dt>
  <dd><%= @application.description %></dd>
  <dt class="font-bold">Planning Authority</dt>
  <dd>
    <%= pa_link_to @application.authority.full_name,
                   authority_path(@application.authority.short_name_encoded) %>
  </dd>
  <dt class="font-bold">& Reference number</dt>
  <dd>
    <div>
    <%# TODO: Add ability to copy with a click %>
      <%= @application.council_reference %>
    </div>
    <%= render Tailwind::DisclosureComponent.new(size: "2xl") do |component| %>
      <% component.with_summary { "What is a reference number?" } %>
      <%# TODO: Improve this terrible text. This is just a placeholder first go. %>
      The reference number is created by the planning authority and is used by them to identify this application.
      If you talk to the planning authority directly or use their website you will need this number to find or refer to this application.
    <% end %>
  </dd>
</dl>

<%# TODO: The icons next to the labels are not all the same size / proportion %>
<dl class="text-2xl text-navy grid md:grid-cols-[18rem_1fr] border-light-grey2 border-y py-4 mt-14">
  <dt class="font-bold md:py-1">
    <div class="flex gap-4">
      <%= image_tag "tailwind/calendar.svg", width: 23, alt: "" %>
      <div>Date sourced</div>
    </div>
  </dt>
  <dd class="md:py-1">
    <%= render "applications/scraped_and_received_text", application: @application %>
  </dd>
  <%# TODO: Do we show the notified line if nobody has been notified? %>
  <dt class="font-bold md:py-1">
    <div class="flex gap-4">
      <%= image_tag "tailwind/letter.svg", width: 23, alt: "" %>
      <div>Notified</div>
    </div>
  </dt>
  <%# TODO: The link in notified text should go to the new alert sign up page %>
  <%# TODO: Should we have the link at all now? %>
  <dd class="md:py-1 md:border-t border-light-grey2">
    <%= render "applications/notified_text", application: @application %>
  </dd>
  <%# TODO: What to do if there are 0 comments? %>
  <dt class="font-bold md:py-1">
    <div class="flex gap-4">
      <%= image_tag "tailwind/comments.svg", width: 23, alt: "" %>
      <div>Comments</div>
    </div>
  </dt>
  <dd class="md:py-1 md:border-t border-light-grey2">
    <%= render "applications/comments_text", comments: @comments %>
  </dd>
</dl>

<div class="mt-12">
  <%# TODO: This button currently has much larger left and right padding than the design %>
  <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", type: :primary, href: "#add-comment", icon: :edit) do %>
    Make a comment on this application
  <% end %>
</div>

<div class="mt-2">
  <%# TODO: Handle situation when authority name is very long %>
  <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", type: :primary, href: external_application_path(@application), icon: :external) do %>
    View more at <%= @application.authority.full_name %> website
  <% end %>
</div>

<%# TODO: Point this button at a new page for sharing the application %>
<div class="mt-2">
  <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", type: :inverse_primary, href: "#", icon: :share) do %>
    Share this application
  <% end %>
</div>

<%# TODO: Only show this block if we don't have an alert covering this area? %>
<%# TODO: Remove duplication between this and applications/_create_alert_form.html.erb %>
<div class="flex flex-col items-center justify-between gap-8 md:flex-row bg-light-grey px-14 mt-14">
  <div class="pt-14 md:pb-14">
    <p class="text-3xl font-bold font-display text-navy">Save this search as an email alert?</p>
    <% if current_user.nil? %>
      <p class="mt-4 text-2xl text-navy">
        <%= pa_link_to "Create an account", new_user_registration_path %>
        or
        <%= pa_link_to "sign in", new_user_session_path %>.
      </p>
      <p class="text-2xl text-navy">
        It only takes a moment.
      </p>
    <% else %>
      <%= form_with model: [:profile, @alert], builder: FormBuilders::Tailwind do |f| %>
        <p class="mt-2 mb-8 text-2xl text-navy">
          Save your search for applications within <%= meters_in_words(@alert.radius_meters) %> of <%= @alert.address %>?
        </p>
        <%= f.hidden_field :address %>
        <%= f.hidden_field :radius_meters %>
        <%= f.button "Save" %>
      <% end %>
    <% end %>
  </div>
  <%= image_tag "tailwind/illustration/save-search.svg", class: "self-end md:pt-14", alt: "" %>
</div>

<section class="pt-20 border-t mt-14 border-light-grey2" id="comments">
  <%= render Tailwind::Heading.new(tag: :h2, extra_classes: "inline-block mb-6").with_content("Comments on this application") %>
  <% if @comments.count > 0 %>
    <div class="relative inline-block ml-4 -top-6">
      <%= render Tailwind::SpeechBubbleComponent.new(size: "4xl", alignment: :right) do %>
        <%= @comments.count %>
      <% end %>
    </div>
  <% end %>

  <%# TODO: Handle situation with 0 comments differently %>
  <p class="text-2xl text-navy">
    Comments made here were sent to <strong><%= @application.comment_recipient_full_name %></strong>.
    <%= pa_link_to "Add your own comment", "#add-comment" %>.
  </p>
  <% @comments.each do |comment| %>
    <div class="pt-12" id="comment<%= comment.id %>">
      <% if comment.id == flash[:published_comment_id] %>
        <div class="mb-8">
          <%= render Tailwind::AlertComponent.new(type: :congratulations) do %>
            <div class="mb-4 ml-4 text-3xl">
              <p class="mb-8">
                Thanks, your comment has been sent to <%= comment.comment_recipient_full_name %> and posted below!
              </p>
              <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", icon: :share, type: :inverse_lavender, href: "https://www.facebook.com/sharer/sharer.php?u=#{comment_url(Comment.first)}&t=") do %>
                Share on Facebook
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
      <%= render comment %>
    </div>
  <% end %>
</section>

<%# TODO: If there is no commenting email address then this section should be hidden (and replaced with some explanatory text) %>
<section class="flex gap-6 mt-14" id="add-comment">
  <div class="mt-20 text-navy text-7xl">‚Äù</div>
  <div class="pt-10 border-t border-dashed border-warm-grey grow">
    <%= render Tailwind::Heading.new(tag: :h2, extra_classes: "mb-3").with_content("Add your own comment") %>
    <% if current_user.nil? %>
      <div class="px-4 py-3 bg-light-grey">
        <p class="text-2xl opacity-50 text-navy">Be polite, clear and to the point so your comment gets listened to.</p>
        <div class="flex justify-center py-12">
          <div class="grid gap-3 sm:inline-grid sm:grid-cols-2">
            <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", type: :primary, href: new_user_registration_path) do %>
              Create an account
            <% end %>
            <%= render Tailwind::ButtonComponent.new(tag: :a, size: "2xl", type: :primary, href: new_user_session_path) do %>
              Sign in
            <% end %>
          </div>
        </div>
      </div>
    <% else %>
      <%= render "comments/form", application: @application, comment: @comment %>
    <% end %>
  </div>
</section>

<%
=begin
%>

<div id="main">
  <div id="application">
    <article id="application-info">
      <div id="comments-area">
        <% if @application.authority.email.present? %>
          <%= render "comments/form_introduction", application: @application %>
        <% else %>
          <%= render "comments/no_authority_email_explanation", application: @application %>
        <% end %>
      </div>
    </article>
  </div>
</div>

<%
=end
%>
