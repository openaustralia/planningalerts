services:
  web:
    build: .
    volumes:
      - .:/app
      - gem_cache:/usr/local/bundle/gems
    ports:
      - "3000:3000"
    depends_on:
      - database
      - postgres
      - redis
      - mailcatcher
      - elasticsearch
    command: "bin/dev"
    tty: true

  database:
    # Using same version as used in production
    # TODO: Upgrade when we can
    image: mysql:5.7
    ports:
      # Give access to the database from your host machine. This is useful
      # if you want to poke around with something like mysql workbench.
      # Note that we're forwarding this to port 13306 on the host machine so
      # that it doesn't conflict with any mysql server you might have running there.
      - 13306:3306
    volumes:
      - database_data:/var/lib/mysql
    environment:
      # The values below need to be the same in config/database.yml
      MYSQL_ROOT_PASSWORD: password

  postgres:
    # Same version as used in production
    image: postgres:15.2
    ports:
      # Give access to the database from your host machine. This is useful
      # if you want to poke around.
      # Note that we're forwarding this to port 15432 on the host machine so
      # that it doesn't conflict with any postgres server you might have running there.
      - 15432:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      # The values below need to be the same in config/database.yml
      POSTGRES_PASSWORD: password
      # We're using the older (less secure) md5 so that pgloader works. Sigh.
      POSTGRES_HOST_AUTH_METHOD: md5
      POSTGRES_INITDB_ARGS: "--auth-host=md5"

  redis:
    # TODO: Try switching to alpine variant for slimmer images
    # We're also using redis 6.2 in production
    image: redis:6.2
    ports:
      - "6379"
    volumes:
      - redis_data:/data

  mailcatcher:
    build:
      context: .
      dockerfile: Dockerfile.mailcatcher
    ports:
      - "1080:1080"

  elasticsearch:
    # Using version 7.17.7 in production. So matching here
    # TODO: Upgrade when we can
    image: elasticsearch:7.17.7
    ports:
      - "9200"
    mem_limit: 1073741824
    environment:
      - "discovery.type=single-node"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

volumes:
  gem_cache:
  database_data:
  postgres_data:
  redis_data:
  elasticsearch_data:
